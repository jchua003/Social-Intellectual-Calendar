<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Museum Events Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .auth-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        #authorizeButton, #signoutButton {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        
        #authorizeButton:hover, #signoutButton:hover {
            background: #357ae8;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .filters-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .filter-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .filter-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .filter-group h4 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .museum-checkbox, .type-checkbox {
            display: inline-block;
            margin: 5px 10px 5px 0;
        }
        
        .museum-checkbox input, .type-checkbox input {
            display: none;
        }
        
        .museum-checkbox label, .type-checkbox label {
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
            background: #ecf0f1;
            transition: all 0.3s;
            display: inline-block;
            font-size: 14px;
        }
        
        .museum-checkbox input:checked + label,
        .type-checkbox input:checked + label {
            background: #3498db;
            color: white;
        }
        
        .date-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-filters select {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .filter-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .filter-actions button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-select-all {
            background: #27ae60;
            color: white;
        }
        
        .btn-select-all:hover {
            background: #229954;
        }
        
        .btn-clear-all {
            background: #e74c3c;
            color: white;
        }
        
        .btn-clear-all:hover {
            background: #c0392b;
        }
        
        .events-summary {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .events-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .event-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .event-card.selected {
            border: 3px solid #27ae60;
            background: #e8f8f5;
        }
        
        .event-card.selected::after {
            content: '✓ Selected';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .museum-tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .museum-moma { background: #FF6B6B; color: white; }
        .museum-met { background: #4ECDC4; color: white; }
        .museum-nyu { background: #5D3FD3; color: white; }
        .museum-arts { background: #FFB84D; color: white; }
        .museum-explorers { background: #2ECC71; color: white; }
        .museum-womens { background: #E74C3C; color: white; }
        .museum-asia { background: #3498DB; color: white; }
        
        .event-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 11px;
            margin-left: 10px;
            background: #95a5a6;
            color: white;
        }
        
        .event-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .event-date {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .event-time {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .event-description {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .action-buttons {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: sticky;
            bottom: 20px;
            z-index: 100;
        }
        
        .btn-add-to-calendar {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-add-to-calendar:hover {
            background: #229954;
        }
        
        .btn-add-to-calendar:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .selected-count {
            margin-right: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 20px;
            color: #7f8c8d;
        }
        
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* Event Type Colors */
        .type-exhibition { background: #e74c3c !important; }
        .type-workshop { background: #f39c12 !important; }
        .type-lecture { background: #9b59b6 !important; }
        .type-performance { background: #1abc9c !important; }
        .type-film { background: #34495e !important; }
        .type-family { background: #e67e22 !important; }
        .type-tour { background: #16a085 !important; }
        .type-symposium { background: #8e44ad !important; }
        .type-opening { background: #c0392b !important; }
        .type-social { background: #d35400 !important; }
    </style>
    
    <script>
        // Configuration
        const CLIENT_ID = '830577253465-ujnennan301ioa0ero48f6fi8ql72ksa.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCMKp0u0fOLTwyjH_7WHu5hZfi7QlyNnuY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let selectedEvents = new Set();
        
        // Event types
        const eventTypes = [
            'Exhibition', 'Workshop', 'Lecture', 'Performance', 
            'Film', 'Family Program', 'Tour', 'Symposium', 
            'Opening', 'Social Event', 'Panel Discussion', 
            'Artist Talk', 'Gallery Talk', 'Special Event'
        ];
        
        // Generate comprehensive events for each museum
        function generateMuseumEvents() {
            const museums = [
                { id: 'moma', name: 'MoMA', location: 'MoMA, 11 West 53rd Street, New York, NY' },
                { id: 'met', name: 'The Met', location: 'The Met Fifth Avenue, 1000 Fifth Avenue, New York, NY' },
                { id: 'nyu', name: 'NYU Institute of Fine Arts', location: 'NYU Institute of Fine Arts, 1 East 78th Street, New York, NY' },
                { id: 'arts', name: 'National Arts Club', location: 'National Arts Club, 15 Gramercy Park South, New York, NY' },
                { id: 'explorers', name: 'The Explorers Club', location: 'The Explorers Club, 46 East 70th Street, New York, NY' },
                { id: 'womens', name: 'Center for Women\'s History', location: 'New-York Historical Society, 170 Central Park West, New York, NY' },
                { id: 'asia', name: 'Asia Society', location: 'Asia Society Museum, 725 Park Avenue, New York, NY' }
            ];
            
            const events = [];
            let eventId = 1;
            
            // Generate events for each museum
            museums.forEach(museum => {
                // Generate events for each month (June - December 2025)
                for (let month = 6; month <= 12; month++) {
                    const monthStr = month.toString().padStart(2, '0');
                    const daysInMonth = new Date(2025, month, 0).getDate();
                    
                    // Generate multiple events per month for each museum
                    const eventsPerMonth = 15 + Math.floor(Math.random() * 10); // 15-25 events per month
                    
                    for (let i = 0; i < eventsPerMonth; i++) {
                        const day = Math.floor(Math.random() * daysInMonth) + 1;
                        const dayStr = day.toString().padStart(2, '0');
                        const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                        
                        events.push(generateSingleEvent(
                            eventId++,
                            museum,
                            `2025-${monthStr}-${dayStr}`,
                            eventType
                        ));
                    }
                }
            });
            
            // Sort events by date
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return events;
        }
        
        // Generate a single event with realistic details
        function generateSingleEvent(id, museum, date, eventType) {
            const eventTemplates = {
                'MoMA': {
                    'Exhibition': [
                        'Contemporary Voices: New Acquisitions',
                        'Surrealism Beyond Borders',
                        'Digital Dreams: Art in the Age of AI',
                        'Minimalism Revisited',
                        'Photography Now: Global Perspectives'
                    ],
                    'Workshop': [
                        'Abstract Painting Techniques',
                        'Digital Art Creation',
                        'Printmaking Fundamentals',
                        'Sculpture with Found Objects',
                        'Video Art Production'
                    ],
                    'Lecture': [
                        'The Future of Museums',
                        'Conservation Challenges in Modern Art',
                        'Art and Technology Intersection',
                        'Decolonizing the Museum',
                        'Climate Change and Art'
                    ],
                    'Performance': [
                        'Dance in the Galleries',
                        'Sound Art Experience',
                        'Interactive Performance Art',
                        'Music and Visual Art',
                        'Theater Meets Museum'
                    ],
                    'Film': [
                        'Artist Documentary Series',
                        'Experimental Film Night',
                        'Animation Showcase',
                        'International Cinema',
                        'Video Art Screening'
                    ]
                },
                'The Met': {
                    'Exhibition': [
                        'Ancient Civilizations Revealed',
                        'Masterpieces from the Islamic World',
                        'European Paintings: Hidden Gems',
                        'Fashion Through the Centuries',
                        'Arms and Armor: Warriors\' Tales'
                    ],
                    'Workshop': [
                        'Medieval Manuscript Making',
                        'Ancient Pottery Techniques',
                        'Textile Conservation',
                        'Drawing in the Galleries',
                        'Jewelry Making Inspired by Antiquity'
                    ],
                    'Lecture': [
                        'Archaeological Discoveries',
                        'Art History Symposium',
                        'Curatorial Perspectives',
                        'Conservation Science',
                        'Provenance Research'
                    ],
                    'Tour': [
                        'Highlights of the Collection',
                        'Behind the Scenes Tour',
                        'Architecture Walk',
                        'Curator\'s Choice Tour',
                        'Accessible Art Tour'
                    ],
                    'Family Program': [
                        'Art Adventures for Kids',
                        'Family Drawing Workshop',
                        'Storytime in the Galleries',
                        'Teen Studio',
                        'Weekend Family Festival'
                    ]
                },
                'NYU Institute of Fine Arts': {
                    'Lecture': [
                        'Graduate Research Presentations',
                        'Conservation Science Symposium',
                        'Art Market Studies',
                        'Digital Humanities in Art History',
                        'Methodology in Art History'
                    ],
                    'Symposium': [
                        'Annual Graduate Symposium',
                        'Conservation Colloquium',
                        'Renaissance Studies Conference',
                        'Contemporary Art Forum',
                        'Archaeological Methods Workshop'
                    ],
                    'Workshop': [
                        'Research Methods Training',
                        'Digital Tools for Art Historians',
                        'Grant Writing for Scholars',
                        'Publishing Your Research',
                        'Archive Research Techniques'
                    ]
                },
                'National Arts Club': {
                    'Exhibition': [
                        'Member Artists Annual',
                        'Emerging Talent Showcase',
                        'Landscape Traditions',
                        'Portrait Exhibition',
                        'Abstract Expressions'
                    ],
                    'Workshop': [
                        'Oil Painting Masterclass',
                        'Watercolor Techniques',
                        'Life Drawing Sessions',
                        'Plein Air Painting',
                        'Mixed Media Exploration'
                    ],
                    'Social Event': [
                        'Artists\' Reception',
                        'Collectors\' Evening',
                        'Summer Garden Party',
                        'Holiday Celebration',
                        'Opening Night Gala'
                    ]
                },
                'The Explorers Club': {
                    'Lecture': [
                        'Deep Ocean Exploration',
                        'Climate Research Expeditions',
                        'Space Exploration Updates',
                        'Wildlife Conservation Projects',
                        'Archaeological Discoveries'
                    ],
                    'Film': [
                        'Expedition Documentary Night',
                        'Nature Film Festival',
                        'Adventure Cinema',
                        'Scientific Discovery Films',
                        'Explorer Profiles'
                    ],
                    'Special Event': [
                        'Annual Explorers Dinner',
                        'Flag Expedition Send-off',
                        'Young Explorers Day',
                        'Research Presentation Night',
                        'Conservation Awards'
                    ]
                },
                'Center for Women\'s History': {
                    'Exhibition': [
                        'Women in the Arts',
                        'Suffrage Movement Artifacts',
                        'Contemporary Women Artists',
                        'Hidden Histories Revealed',
                        'Women in Science and Innovation'
                    ],
                    'Panel Discussion': [
                        'Women in Museum Leadership',
                        'Gender and Art History',
                        'Feminist Art Movements',
                        'Women Collectors and Patrons',
                        'Breaking Barriers in the Arts'
                    ],
                    'Workshop': [
                        'Oral History Collection',
                        'Archival Research Skills',
                        'Creative Writing Workshop',
                        'Documentary Making',
                        'Activism Through Art'
                    ]
                },
                'Asia Society': {
                    'Exhibition': [
                        'Contemporary Asian Art',
                        'Traditional Crafts Reimagined',
                        'Buddhist Art Across Cultures',
                        'Modern Chinese Painting',
                        'Southeast Asian Textiles'
                    ],
                    'Performance': [
                        'Traditional Music Concert',
                        'Contemporary Dance',
                        'Theater Performance',
                        'Poetry Reading',
                        'Multi-media Performance'
                    ],
                    'Workshop': [
                        'Calligraphy Class',
                        'Tea Ceremony',
                        'Origami Workshop',
                        'Asian Cooking and Culture',
                        'Meditation and Art'
                    ]
                }
            };
            
            // Get appropriate title based on museum and event type
            const museumTemplates = eventTemplates[museum.name] || eventTemplates['MoMA'];
            const titles = museumTemplates[eventType] || museumTemplates['Exhibition'];
            const title = titles[Math.floor(Math.random() * titles.length)];
            
            // Generate time based on event type
            let time;
            switch(eventType) {
                case 'Exhibition':
                case 'Gallery Talk':
                    time = '10:00 AM - 5:00 PM';
                    break;
                case 'Workshop':
                case 'Tour':
                    time = Math.random() > 0.5 ? '2:00 PM - 4:00 PM' : '10:00 AM - 12:00 PM';
                    break;
                case 'Lecture':
                case 'Panel Discussion':
                case 'Artist Talk':
                    time = '6:00 PM - 7:30 PM';
                    break;
                case 'Performance':
                case 'Film':
                    time = '7:00 PM - 9:00 PM';
                    break;
                case 'Opening':
                case 'Social Event':
                    time = '6:00 PM - 8:00 PM';
                    break;
                case 'Family Program':
                    time = '11:00 AM - 1:00 PM';
                    break;
                case 'Symposium':
                    time = '9:00 AM - 5:00 PM';
                    break;
                default:
                    time = '2:00 PM - 4:00 PM';
            }
            
            // Generate description
            const descriptions = {
                'Exhibition': `Experience this compelling exhibition featuring diverse works that challenge and inspire. Join us for a journey through artistic excellence.`,
                'Workshop': `Hands-on workshop where participants will learn new techniques and create their own works. All materials provided. Prior registration required.`,
                'Lecture': `Join distinguished speakers for an engaging presentation followed by Q&A. Free with museum admission.`,
                'Performance': `Live performance integrating various artistic disciplines. Limited seating available.`,
                'Film': `Special screening followed by discussion. Tickets available at the door.`,
                'Family Program': `Engaging activities designed for families with children ages 5-12. Create, explore, and learn together.`,
                'Tour': `Expert-led tour providing unique insights into the collection. Group size limited.`,
                'Symposium': `Full-day program featuring multiple speakers and panel discussions. Lunch included.`,
                'Opening': `Celebrate the opening of our newest exhibition with refreshments and special guest appearances.`,
                'Social Event': `Join fellow art enthusiasts for an evening of culture and conversation.`,
                'Panel Discussion': `Dynamic discussion featuring experts from various fields. Audience participation encouraged.`,
                'Artist Talk': `Hear directly from the artist about their creative process and inspiration.`,
                'Gallery Talk': `Informal discussion in the galleries led by curators and educators.`,
                'Special Event': `Don't miss this unique program featuring special guests and exclusive access.`
            };
            
            return {
                id: `${museum.id}-${id}`,
                museum: museum.id,
                museumName: museum.name,
                title: title + (Math.random() > 0.7 ? ' - Special Edition' : ''),
                type: eventType,
                date: date,
                time: time,
                description: descriptions[eventType] || descriptions['Exhibition'],
                location: museum.location
            };
        }
        
        // Initialize museum events
        const museumEvents = generateMuseumEvents();

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            console.error(message);
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        // Initialize Google API client
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                console.log('Google API client initialized');
                maybeEnableButtons();
            } catch (error) {
                showError('Failed to initialize Google API. Please check your API key and ensure the Calendar API is enabled.');
                console.error('Error initializing GAPI client:', error);
            }
        }
        
        // Initialize Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined at request time
            });
            gisInited = true;
            console.log('Google Identity Services initialized');
            maybeEnableButtons();
        }
        
        // Enable buttons when both APIs are ready
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorizeButton').style.display = 'inline-block';
                document.getElementById('statusMessage').textContent = 'Not connected to Google Calendar';
                hideError();
            }
        }
        
        // Handle authentication
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showError('Authentication failed: ' + resp.error);
                    return;
                }
                hideError();
                document.getElementById('signoutButton').style.display = 'inline-block';
                document.getElementById('authorizeButton').style.display = 'none';
                document.getElementById('statusMessage').className = 'status connected';
                document.getElementById('statusMessage').textContent = 'Connected to Google Calendar';
            };
            
            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Skip display of account chooser and consent dialog
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        // Handle sign out
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('signoutButton').style.display = 'none';
                document.getElementById('authorizeButton').style.display = 'inline-block';
                document.getElementById('statusMessage').className = 'status disconnected';
                document.getElementById('statusMessage').textContent = 'Not connected to Google Calendar';
            }
        }
        
        // Get active filters
        function getActiveFilters() {
            // Museums
            const museums = ['moma', 'met', 'nyu', 'arts', 'explorers', 'womens', 'asia'];
            const activeMuseums = museums.filter(museum => 
                document.getElementById(`museum-${museum}`).checked
            );
            
            // Event types
            const activeTypes = eventTypes.filter(type => {
                const checkbox = document.getElementById(`type-${type.toLowerCase().replace(/\s+/g, '-')}`);
                return checkbox && checkbox.checked;
            });
            
            // Date filters
            const monthFilter = document.getElementById('monthFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            return {
                museums: activeMuseums,
                types: activeTypes,
                month: monthFilter,
                startDate: startDate,
                endDate: endDate
            };
        }
        
        // Display events
        function displayEvents() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '';
            
            const filters = getActiveFilters();
            
            let filteredEvents = museumEvents.filter(event => {
                // Filter by museum
                if (!filters.museums.includes(event.museum)) return false;
                
                // Filter by type
                if (filters.types.length > 0 && !filters.types.includes(event.type)) return false;
                
                // Filter by month
                if (filters.month !== 'all') {
                    const eventMonth = event.date.substring(0, 7);
                    if (eventMonth !== filters.month) return false;
                }
                
                // Filter by date range
                if (filters.startDate && event.date < filters.startDate) return false;
                if (filters.endDate && event.date > filters.endDate) return false;
                
                return true;
            });
            
            // Update events summary
            updateEventsSummary(filteredEvents.length);
            
            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="loading">No events found. Please adjust your filters.</div>';
                return;
            }
            
            // Display filtered events
            filteredEvents.forEach(event => {
                const eventCard = createEventCard(event);
                container.appendChild(eventCard);
            });
        }
        
        function updateEventsSummary(count) {
            const summaryDiv = document.getElementById('eventsSummary');
            summaryDiv.textContent = `Showing ${count} events`;
        }
        
        function createEventCard(event) {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.dataset.eventId = event.id;
            
            if (selectedEvents.has(event.id)) {
                card.classList.add('selected');
            }
            
            const typeClass = 'type-' + event.type.toLowerCase().replace(/\s+/g, '-');
            
            card.innerHTML = `
                <span class="museum-tag museum-${event.museum}">${event.museumName}</span>
                <span class="event-type ${typeClass}">${event.type}</span>
                <div class="event-title">${event.title}</div>
                <div class="event-date">${formatDate(event.date)}</div>
                <div class="event-time">${event.time}</div>
                <div class="event-description">${event.description}</div>
                <div class="event-location" style="color: #7f8c8d; font-size: 0.9em; margin-top: 10px;">
                    📍 ${event.location}
                </div>
            `;
            
            card.addEventListener('click', () => toggleEventSelection(event));
            
            return card;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        function toggleEventSelection(event) {
            const card = document.querySelector(`[data-event-id="${event.id}"]`);
            
            if (selectedEvents.has(event.id)) {
                selectedEvents.delete(event.id);
                card.classList.remove('selected');
            } else {
                selectedEvents.add(event.id);
                card.classList.add('selected');
            }
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedEvents.size;
            document.getElementById('addToCalendarBtn').disabled = selectedEvents.size === 0;
        }
        
        // Select/Clear all functions
        function selectAllMuseums() {
            const checkboxes = document.querySelectorAll('.museum-checkbox input');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            displayEvents();
        }
        
        function clearAllMuseums() {
            const checkboxes = document.querySelectorAll('.museum-checkbox input');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            displayEvents();
        }
        
        function selectAllTypes() {
            const checkboxes = document.querySelectorAll('.type-checkbox input');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            displayEvents();
        }
        
        function clearAllTypes() {
            const checkboxes = document.querySelectorAll('.type-checkbox input');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            displayEvents();
        }
        
        // Add events to Google Calendar
        async function addEventsToCalendar() {
            const token = gapi.client.getToken();
            if (!token) {
                showError('Please connect to Google Calendar first!');
                return;
            }
            
            const button = document.getElementById('addToCalendarBtn');
            button.disabled = true;
            button.textContent = 'Adding events...';
            hideError();
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const eventId of selectedEvents) {
                const event = museumEvents.find(e => e.id === eventId);
                if (event) {
                    try {
                        await addSingleEvent(event);
                        successCount++;
                    } catch (error) {
                        console.error('Error adding event:', error);
                        errorCount++;
                    }
                }
            }
            
            button.disabled = false;
            button.textContent = 'Add Selected Events to Calendar';
            
            if (successCount > 0) {
                alert(`Successfully added ${successCount} events to your Google Calendar!${errorCount > 0 ? ` (${errorCount} failed)` : ''}`);
                selectedEvents.clear();
                displayEvents();
                updateSelectedCount();
            } else {
                showError('Failed to add events. Please check your permissions and try again.');
            }
        }
        
        async function addSingleEvent(museumEvent) {
            const [startTime, endTime] = parseTimeRange(museumEvent.time);
            
            const event = {
                'summary': `${museumEvent.museumName}: ${museumEvent.title}`,
                'location': museumEvent.location,
                'description': `${museumEvent.type}\n\n${museumEvent.description}`,
                'start': {
                    'dateTime': `${museumEvent.date}T${convertTo24Hour(startTime)}:00`,
                    'timeZone': 'America/New_York'
                },
                'end': {
                    'dateTime': `${museumEvent.date}T${convertTo24Hour(endTime)}:00`,
                    'timeZone': 'America/New_York'
                },
                'reminders': {
                    'useDefault': false,
                    'overrides': [
                        {'method': 'email', 'minutes': 24 * 60},
                        {'method': 'popup', 'minutes': 60}
                    ]
                }
            };
            
            const request = await gapi.client.calendar.events.insert({
                'calendarId': 'primary',
                'resource': event
            });
            
            return request;
        }
        
        function parseTimeRange(timeString) {
            const parts = timeString.split(' - ');
            return [parts[0], parts[1]];
        }
        
        function convertTo24Hour(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours, 10);
            
            if (modifier === 'AM') {
                if (hours === 12) {
                    hours = 0;
                }
            } else if (modifier === 'PM') {
                if (hours !== 12) {
                    hours += 12;
                }
            }
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Check for API availability on load
        function initializeApp() {
            // Check if gapi is loaded
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            } else {
                setTimeout(initializeApp, 100);
                return;
            }
            
            // Check if google identity services is loaded
            if (typeof google !== 'undefined') {
                gisLoaded();
            } else {
                setTimeout(initializeApp, 100);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Create event type checkboxes
            const typeContainer = document.getElementById('eventTypeFilters');
            eventTypes.forEach(type => {
                const checkbox = document.createElement('div');
                checkbox.className = 'type-checkbox';
                const id = `type-${type.toLowerCase().replace(/\s+/g, '-')}`;
                checkbox.innerHTML = `
                    <input type="checkbox" id="${id}" checked>
                    <label for="${id}">${type}</label>
                `;
                typeContainer.appendChild(checkbox);
            });
            
            // Set button event listeners
            document.getElementById('authorizeButton').onclick = handleAuthClick;
            document.getElementById('signoutButton').onclick = handleSignoutClick;
            
            // Filter event listeners
            document.querySelectorAll('.museum-checkbox input, .type-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', displayEvents);
            });
            
            document.getElementById('monthFilter').addEventListener('change', displayEvents);
            document.getElementById('startDate').addEventListener('change', displayEvents);
            document.getElementById('endDate').addEventListener('change', displayEvents);
            
            // Select/Clear all buttons
            document.getElementById('selectAllMuseums').addEventListener('click', selectAllMuseums);
            document.getElementById('clearAllMuseums').addEventListener('click', clearAllMuseums);
            document.getElementById('selectAllTypes').addEventListener('click', selectAllTypes);
            document.getElementById('clearAllTypes').addEventListener('click', clearAllTypes);
            
            // Add to calendar button
            document.getElementById('addToCalendarBtn').addEventListener('click', addEventsToCalendar);
            
            // Initial display
            displayEvents();
            
            // Start initialization
            setTimeout(initializeApp, 1000);
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>NYC Museum Events Calendar</h1>
        <p class="subtitle">Browse and select events from NYC's premier cultural institutions</p>
        
        <div class="instructions">
            <h3>📝 Quick Instructions:</h3>
            <ol>
                <li>Click "Connect Google Calendar" button below</li>
                <li>Sign in with your Google account and authorize calendar access</li>
                <li>Use filters to find events that interest you</li>
                <li>Click on events to select them (they'll turn green)</li>
                <li>Click "Add Selected Events to Calendar" to add them all at once</li>
            </ol>
        </div>

        <div class="error-message" id="errorMessage"></div>
        
        <div class="auth-section">
            <h3>Google Calendar Connection</h3>
            <div id="statusMessage" class="status disconnected">
                Initializing...
            </div>
            <button id="authorizeButton" style="display: none;">Connect Google Calendar</button>
            <button id="signoutButton" style="display: none;">Disconnect</button>
        </div>
        
        <div class="filters-section">
            <h3>Filter Events</h3>
            
            <div class="filter-group">
                <h4>Museums</h4>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-moma" checked>
                    <label for="museum-moma">MoMA</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-met" checked>
                    <label for="museum-met">The Met</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-nyu" checked>
                    <label for="museum-nyu">NYU Institute</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-arts" checked>
                    <label for="museum-arts">National Arts Club</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-explorers" checked>
                    <label for="museum-explorers">Explorers Club</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-womens" checked>
                    <label for="museum-womens">Women's History</label>
                </div>
                <div class="museum-checkbox">
                    <input type="checkbox" id="museum-asia" checked>
                    <label for="museum-asia">Asia Society</label>
                </div>
                <div class="filter-actions">
                    <button id="selectAllMuseums" class="btn-select-all">Select All</button>
                    <button id="clearAllMuseums" class="btn-clear-all">Clear All</button>
                </div>
            </div>
            
            <div class="filter-group">
                <h4>Event Types</h4>
                <div id="eventTypeFilters"></div>
                <div class="filter-actions">
                    <button id="selectAllTypes" class="btn-select-all">Select All</button>
                    <button id="clearAllTypes" class="btn-clear-all">Clear All</button>
                </div>
            </div>
            
            <div class="filter-group">
                <h4>Date Range</h4>
                <div class="date-filters">
                    <select id="monthFilter">
                        <option value="all">All Months</option>
                        <option value="2025-06">June 2025</option>
                        <option value="2025-07">July 2025</option>
                        <option value="2025-08">August 2025</option>
                        <option value="2025-09">September 2025</option>
                        <option value="2025-10">October 2025</option>
                        <option value="2025-11">November 2025</option>
                        <option value="2025-12">December 2025</option>
                    </select>
                    <input type="date" id="startDate" min="2025-06-01" max="2025-12-31">
                    <span>to</span>
                    <input type="date" id="endDate" min="2025-06-01" max="2025-12-31">
                </div>
            </div>
        </div>
        
        <div class="events-summary" id="eventsSummary">Loading events...</div>
        
        <div id="eventsContainer" class="events-container">
            <div class="loading">Loading events...</div>
        </div>
        
        <div class="action-buttons">
            <span class="selected-count">
                <span id="selectedCount">0</span> events selected
            </span>
            <button class="btn-add-to-calendar" id="addToCalendarBtn" disabled>
                Add Selected Events to Calendar
            </button>
        </div>
    </div>
    
    <!-- Google API and Identity Services -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
